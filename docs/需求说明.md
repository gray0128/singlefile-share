# SingleFile Share 需求说明

## 需求目标

实现一个简单的单文件分享服务，专门用于分享由 SingleFile 扩展生成的 HTML 文件。

## 需求说明

用户可以上传 SingleFile 生成的 HTML 文件，系统自动将其保存到对象存储，并生成一个分享链接。其他用户可以通过该链接访问或下载该 HTML 文件。

### 1. 文件上传
- **方式一：SingleFile 扩展直传**
    - 用户在 SingleFile 扩展中直接配置对象存储（R2）信息。
    - **路径处理**: 
        - 推荐配置路径为 `files/{user_id}/`。
        - **根目录自动归档**: 若用户未配置路径导致文件上传至根目录，系统将自动把这些文件移动至**主管理员**的目录下 (`files/{admin_id}/`) 并在管理员后台可见，以强制执行文件隔离策略。
    - **元数据同步**: 后端通过 **Cron 定时任务**（每分钟）自动扫描存储桶，感知新文件并创建数据库记录。
- **方式二：后台页面上传**
    - 用户在仪表盘页面手动上传本地 HTML 文件，系统自动存入 `files/{user_id}/` 目录。
- **通用处理**:
    - **文件限制**: 仅支持 HTML (.html, .htm) 和 Markdown (.md) 文件，最大 10MB。
    - **元数据提取**: 自动提取 Title 作为默认展示名（Markdown 文件提取文件名）。
    - **严格隔离**: 存储桶内所有文件必须位于 `files/{user_id}/` 目录下。

### 2. 文件存储
- **对象存储**: 使用 Cloudflare R2 存储 HTML 文件内容。
- **存储结构**: `files/{user_id}/{uuid}.html`。
- **元数据存储**: 使用 Cloudflare D1 数据库存储文件元信息。
    - 字段：展示名、原始文件名、文件大小、上传时间、文件ID、分享ID、所有者ID。

### 3. 文件管理
用户登录后进入仪表盘，可以管理自己的文件：
- **新建 Markdown**: 直接创建空的 Markdown 文件并打开编辑器
    - 自动生成文件名：`未命名-YYYY-MM-DD.md`
    - 初始显示名称为"未命名"
    - 保存时若内容包含 `# 一级标题`，自动更新显示名称为标题内容
- **列表展示**: 采用 **瀑布流 (Masonry)** 布局展示文件卡片，自动适应屏幕宽度。
    - **无图标设计**: 移除文件图标，以展示名为核心视觉元素。
    - **极简交互**: 文件名即为点击区域（预览），鼠标悬停即展示更多元数据。
- **操作**:
    - **查看**: 预览 HTML 文件内容。
    - **重命名**: 修改文件的展示名称（采用统一风格的模态框交互）。
    - **编辑详情**:
        - **描述**: 为文件添加/修改一段纯文本描述。
        - **标签**: 为文件添加/删除标签（支持多标签）。
    - **删除**: 删除文件及其分享链接。
    - **分享开关**: 开启/关闭分享功能。
    - **筛选**:
        - 支持按文件名、描述内容进行模糊搜索。
        - 支持按标签筛选文件列表。
- **文件统计**: 标题区域实时显示文件总数和已分享文件数量。

### 3.1 标签管理
- 用户可以创建自定义标签（TagName）。
- 可以对标签进行重命名和删除操作。
- 标签与文件是多对多关系。

### 4. 文件分享与访问
- **分享页**:
    - 访问 `/s/:share_id`加载分享页。
    - 分享页内嵌 iframe 展示 HTML 内容，或提供"原样预览"按钮。
    - 提供"下载文件"按钮。
- **原生访问**:
    - 提供 `/raw/:share_id` 接口直接返回内容，允许浏览器渲染（需注意安全策略，如 CSP）。
    - **Markdown 渲染**: `.md` 文件通过 `/raw/:share_id` 访问时自动渲染为 HTML，支持：
      - GFM (GitHub Flavored Markdown)
      - Mermaid 流程图、时序图等
      - 代码高亮
    - **下载模式**: 添加 `?download=1` 参数可下载原始 Markdown 文件（而非渲染后的 HTML）。

### 5. 用户管理体系
- **角色 (Roles)**:
    - **Admin**: 系统管理员。可管理所有用户、文件及系统配置。
    - **User**: 普通用户。通过 GitHub OAuth 注册。
- **状态流转 (User Lifecycle)**:
    - **Pending (待审核)**: 注册后默认状态，无法上传文件，仅可退出。
    - **Active (正常)**: 管理员审核通过后，具备完整权限。
    - **Locked (已锁定)**: 违规用户被管理员锁定，禁止操作。
- **管理员后台 (Admin Dashboard)**:
    - **用户列表**: 查看用户状态、已用容量、注册时间。
    - **操作**: 审核通过 (Approve)、锁定/解锁 (Lock/Unlock)、修改容量配额。
- **存储配额**:
    - 默认每位用户 **100MB** 总容量。
    - 管理员可针对特定用户调整配额。

### 6. 核心功能细节补充
- **文件管理**:
    - **复制链接**: 一键复制分享链接到剪贴板。
    - **状态可视化**: 清晰展示分享状态（开启/关闭）。
- **安全预览**:
    - 预览 HTML 时必须进行 XSS 清洗或使用沙箱隔离。

## UI/UE

延续 `svgshare` 的设计风格：
- **风格**: Future Tech (未来科技感)。
- **配色**: 深色模式 (#0a0a0a) + 电光橙 (#FF3300) 点缀。
- **布局**: Bento Grid 高度结构化布局。
- **特效**: 噪点纹理 (Noise) + 扫描线 (Scanline)。
- **交互**: 无构建原生 ESM，极速加载。

## 非功能需求
- **架构**: Cloudflare Workers + D1 + R2，由于无构建过程，要求代码结构清晰模块化。
- **性能**: 利用 Cloudflare Edge 缓存分享页；文件内容通过 R2 分发。
- **时区配置**: 支持通过环境变量 `DISPLAY_TIMEZONE` 配置前端时间展示的时区（默认 `Asia/Shanghai`）。
- **安全**:
    - **资源隔离**: R2 存储桶设为私有，仅通过 Worker 鉴权访问。
    - **CSP 策略**: 严格的内容安全策略，防止托管的 HTML 攻击主站。
- **兼容性**: 适配主流现代浏览器，移动端友好。

## 技术约束
- **前端**: No-Build, Plain HTML/CSS/JS (ES Modules).
- **部署**: Wrangler.

---

## 变更历史

| 版本 | 日期 | 变更内容 |
| :--- | :--- | :--- |
| v1.0 | 2026-01-20 | 初始版本 |
| v1.1 | 2026-01-21 23:34:03 | 新增文件统计功能、重命名模态框交互优化 |
| v1.2 | 2026-02-13 | 新增 Markdown (.md) 文件支持，含 Mermaid 流程图、代码高亮；增加 `?download=1` 下载参数；优化 Markdown 内容样式 |
| v1.3 | 2026-02-15 | 新增"新建 Markdown"功能，直接创建空文件并打开编辑器；保存时自动根据一级标题更新显示名称 |
